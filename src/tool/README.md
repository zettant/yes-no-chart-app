# Yes/No Chart 集計ツール

このツールは、Yes/Noチャートシステムで収集された診断結果データを集計し、CSVファイルと復号化された写真ファイルを出力するコマンドラインツールです。

## 機能概要

- SQLite3データベースから診断結果データを取得
- チャート別にデータを分類して処理
- CSV形式での診断結果出力
- AES256-CTR暗号化された写真ファイルの復号化
- macOSネイティブバイナリ（CGO不使用）

## ビルド方法

プロジェクトルートディレクトリから以下のコマンドを実行してください：

```bash
# 集計ツールのみビルド
make build-tool

# 全コンポーネントをビルド（集計ツールも含む）
make build
```

ビルドが成功すると、プロジェクトルートに `aggregation-tool` という実行ファイルが生成されます。

## 使用方法

```bash
./aggregation-tool <dbファイルパス> <写真ディレクトリ> <出力先ディレクトリ>
```

### 引数

1. **dbファイルパス**: SQLite3データベースファイルのパス（通常は `./volumes/db/database.db`）
2. **写真ディレクトリ**: 暗号化された写真ファイルが保存されているディレクトリ（通常は `./volumes/photos`）
3. **出力先ディレクトリ**: CSVファイルと復号化写真を保存するディレクトリ

### 実行例

```bash
./aggregation-tool ./volumes/db/database.db ./volumes/photos ./output
```

## 出力ファイル

### CSVファイル

各チャートごとに `[チャート名].csv` という名前のファイルが生成されます。

**ファイル構造：**
```csv
ID,時刻,結果番号,文章,選択履歴
1,2023-12-01T10:00:00Z,1,あなたは外向的なタイプです,1,2,2,1,3,2
```

**カラム説明：**
- **ID**: 診断結果のID（データベースの主キー）
- **時刻**: 診断実施日時（ISO8601形式）
- **結果番号**: 診断結果ID（決定木タイプ）またはポイント値（ポイントタイプ）
- **文章**: 診断結果の説明文
- **選択履歴**: 設問IDと選択肢番号の組み合わせ（設問ID, 選択肢番号, 設問ID, 選択肢番号...）

### 写真ファイル

復号化された写真は `[診断結果ID].jpg` という名前で保存されます。

例：`1.jpg`, `2.jpg`, `3.jpg`

## 技術仕様

### 暗号化/復号化

- **アルゴリズム**: AES256-CTR
- **キー生成**: パスフレーズのSHA256ハッシュ値
- **ファイル構造**: IV（16バイト）+ 暗号化データ

### データベース接続

- **ドライバ**: `modernc.org/sqlite`（Pure Go、CGO不使用）
- **ORM**: GORM v1.25.5

### エラーハンドリング

- データベースファイルが存在しない場合はエラー終了
- 写真ディレクトリが存在しない場合はエラー終了
- 出力先ディレクトリが存在しない場合は自動作成
- 個別の写真ファイルが見つからない場合は警告表示して続行

## 実行時の出力例

```bash
$ ./aggregation-tool ./volumes/db/database.db ./volumes/photos ./output

出力先ディレクトリを作成しました: ./output
取得したチャート数: 2

チャート '性格診断' を処理中...
  診断結果数: 15件
  CSVファイルを生成: ./output/性格診断.csv
  復号化した写真数: 15件

チャート '健康チェック' を処理中...
  診断結果数: 8件
  CSVファイルを生成: ./output/健康チェック.csv
  復号化した写真数: 8件

=== 集計完了 ===
チャート '性格診断': 15件の結果を処理
チャート '健康チェック': 8件の結果を処理
```

## トラブルシューティング

### よくあるエラー

**「データベースファイルが存在しません」**
```bash
引数エラー: データベースファイルが存在しません: ./volumes/db/database.db
```
→ データベースファイルのパスを確認してください。システムが起動されていることを確認してください。

**「写真ディレクトリが存在しません」**
```bash
引数エラー: 写真ディレクトリが存在しません: ./volumes/photos
```
→ 写真ディレクトリのパスを確認してください。

**「AES復号エラー」**
```bash
集計処理エラー: チャート 'テスト' の写真復号エラー: 結果ID 1 の写真復号エラー: AES復号エラー: 暗号化データが短すぎます
```
→ 写真ファイルが破損しているか、正しく暗号化されていない可能性があります。

### デバッグ情報

ツールは処理の進行状況を詳細に表示します：

- 取得したチャート数
- 各チャートの処理状況
- 診断結果数
- 復号化した写真数
- 最終的な処理結果

## 開発情報

### ファイル構成

```
src/tool/
├── main.go      # メイン処理とコマンドライン引数解析
├── models.go    # データベースモデル定義
├── csv.go       # CSV出力処理
├── crypto.go    # 暗号化/復号化処理
├── go.mod       # Go モジュール定義
└── README.md    # このファイル
```

### 依存関係

- `gorm.io/driver/sqlite`: SQLiteドライバ
- `gorm.io/gorm`: ORMライブラリ
- 標準ライブラリのみ（crypto, encoding, os, path等）

### コード品質

- 全ての関数に詳細な日本語コメント
- エラーハンドリングの徹底
- ログ出力による実行状況の可視化
- Pure Goによるクロスプラットフォーム対応