# ツール設計

## 概要

* 集計ツールは、go + gormで実装する
* 集計ツールは、コマンドラインツールとする
* ツールの引数は、dbファイルパスと写真ディレクトリ、および出力先ディレクトリとする
  * dbファイルパスと写真ディレクトリは存在しなければエラーを返す
  * 出力先ディレクトリは存在しなければ作成する

* sqlite3のドライバは、pure goのドライバ（modernc.org/sqlite）を用い、CGOは利用しない

* コードは、src/tool/に実装する



## 集計処理

コマンドを起動すると、引数を解析し、ディレクトリの存在チェックをした後に、以下の処理を実施する。

1. chartテーブルから全てのレコードを取得し、各レコードをチャート情報としてオブジェクト化しておく
2. チャート情報オブジェクトを一つずつ取り出して、以下の処理を実施する。全てのオブジェクトを処理するまで繰り返す
3. resultテーブルから、chart_nameがチャート情報のnameと合致する診断結果レコードをすべて取得する
4. 後述するCSV仕様に従って、取得した診断結果レコードをCSV情報にする
5. また、それぞれの結果レコードのpassphraseを用いて写真ディレクトリの該当ファイルを復号し、出力先ディレクトリに出力する
   * 復号するファイル名は、結果レコードのIDであり、出力するファイル名は、"[id].jpg"とする
   * ファイルはAES256-CTRで暗号化されている。passphraseをSHA256ハッシュしたものを復号キーとする
6. 全ての復号が完了したら、ファイル名を"[チャート名].csv"としてCSVファイルを出力先ディレクトリに書き出す
7. 未処理のチャート情報オブジェクトが残っていれば手順3に戻る。全て完了したら、出力したチャート名とそれぞれの結果件数を表示して終了する



## CSV仕様

### チャートタイプがsingleとdecisionの場合

出力するCSVファイルは、診断結果ごとに行をなし、各行は以下のようなカラム構成とする。

```text
resultテーブルのid,実施時刻,診断結果ID,結果文章,設問ID,選択肢番号,設問ID,選択肢番号,,,,,,,
```

第5カラム以降は、チャートの選択によって長さが変わる。一つの設問に対して、設問IDとその設問における選択肢の番号（1から5のいずれか）を書き出す。

なお、ヘッダ行には、最初の5カラム分までを以下のように出力する。

```text
ID,時刻,結果番号,文章,選択履歴
```



### チャートタイプがmultiの場合

出力するCSVファイルは、診断結果ごとに行をなし、各行は以下のようなカラム構成とする。

```text
resultテーブルのid,実施時刻,1番目カテゴリ名前,1番目カテゴリのポイント,1番目カテゴリの結果文章,2番目カテゴリの名前,2番目カテゴリのポイント,2番目カテゴリの結果文章,,,,,,設問ID,選択肢番号,設問ID,選択肢番号,,,,,,,
```

第3カラム以降は、カテゴリごとに名前とポイントと結果文章を列挙する。さらにその後に、設問一つずつに対して設問IDとその設問における選択肢の番号（1から5のいずれか）を書き出す。

なお、ヘッダ行には、前半のカラムに対してだけ以下のヘッダを記載する。後半の設問ID以降のヘッダは不要。
)

```text
ID,時刻,1番目カテゴリ名前,1番目カテゴリのポイント,1番目カテゴリの結果文章,2番目カテゴリの名前,2番目カテゴリのポイント,2番目カテゴリの結果文章,,,,,
```





## Makefile

ツールのビルドには、以下のmakeルールをサーバシステムのMakefileに追加する。

| ルール名   | 役割                                                         |
| ---------- | ------------------------------------------------------------ |
| build-tool | 集計ツールをビルドし、プロジェクトルートディレクトリにコピーする |
| build      | build-server、build-chart、build-setting、build-toolを全て実行する |
| clean      | buildによる生成物を削除する                                  |





