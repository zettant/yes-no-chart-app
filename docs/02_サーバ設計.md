# サーバ設計

## 概要

* バックエンドサーバは、go + gin + gormで実装する
* バックエンド機能は、REST APIで利用できるようにする
* sqlite3のドライバは、pure goのドライバ（modernc.org/sqlite）を用い、CGOは利用しない
* reverse proxyを外部に設置することを前提とし、バックエンドサーバはhttpで待ち受ける
  * アプリコンテンツおよびREST APIともに、port = 80 で待ち受ける
* バックエンドサーバは、src/backend/の下に実装する
* 診断アプリ、設定アプリのコンテンツも、バックエンドサーバでホスティングする



## REST API

このサーバの役割は、チャート情報のアプリへの配布、診断結果の保存である。このサーバはそのためのREST APIを提供する。

### エンドポイント一覧

| HTTPメソッド | パス                | ハンドラー関数         | 役割               |
| ------------ | ------------------- | ---------------------- | ------------------ |
| GET          | `/api/charts`       | `GetChartsHandler`     | チャート一覧取得   |
| POST         | `/api/register`     | `RegisterChartHandler` | チャート保存・作成 |
| DELETE       | `/api/charts/:name` | `DeleteChartHandler`   | チャート削除       |
| POST         | `/api/save`         | `SaveResultHandler`    | 診断結果保存       |

### チャート管理 API

#### チャート一覧取得

**エンドポイント:** `GET /api/charts`

保存されているチャート情報を全て返す。

#### チャート保存・作成

**エンドポイント:** `POST /api/register`

チャート情報のJSON文字列を受信し、chartテーブルに保存する。保存できるチャート情報数は最大3つとし、4つ目を登録しようとするとエラーを返す。

#### チャート削除

**エンドポイント:** `DELETE /api/charts/:name`

指定されたチャート名のチャートをchartテーブルから削除する。

### 診断機能 API

#### 診断結果保存

**エンドポイント:** `POST /api/save`

診断結果情報（IResult型のオブジェクト）をresultテーブルに保存する。なお、historyの値は、JSON文字列に変換してresultテーブルレコードにする。

またこのとき、診断結果に含まれるphotoプロパティの内容は以下のように処理する。

1. photoプロパティの値はBase64文字列であるため、まずこれをデコードしてバイナリデータにする
2. 得られたバイナリデータをAES256-CTRで暗号化する
   - 暗号化キーには、ランダム文字列（アルファベット大文字小文字数字からなる32文字）のSHA256ハッシュ値を用いる
3. 暗号化する際に生成したランダム文字列は、resultテーブルのレコードにpassphraseとして格納し、photoは削除してレコードを登録する
4. 暗号化したファイルは、登録したレコードのidと同じ名前にしてファイルストレージに保存する



## Webホスティング

以下のURLパスにそれぞれのWebアプリをホスティングする。

| Webアプリ名 | URLパス  | コンテンツ格納場所 |
| ----------- | -------- | ------------------ |
| setting_app | /setting | src/setting_app/   |
| chart_app   | /chart   | src/chart_app/     |

src/setting_app/およびsrc/chart_app/にはビルド済みのコンテンツだけを配置する。また、どちらのコンテンツに対しても、index.htmlへのフォールバックルーティングを設定すること。



## docker環境

本システムはdockerで動作させる。docker-composeで制御し、以下のような環境を構築する。

* volumes/ディレクトリの下に、bin/、photos/、db/のディレクトリをおき、docker volumeとしてそれぞれマウントする
* volumes/bin/には、バックエンドサーバの実行ファイル、setting_app/、chart_app/のコンテンツファイルを置く
  * dockerイメージにせず、volumeマウントにするのは、開発しやすくするためである

  * Makefileにmakeルールを記述し、volumes/bin/の下へのデプロイできるようにする

* volumes/db/には、sqlite3のdbファイルを置く
* volumes/photos/には、暗号化された画像ファイルを保存する
* portsで解放するのは、tcp/80とtcp/15000とする



## Makefile

ビルドやデプロイなどの作業は、makeルールとして記述して効率化する。管理者が直接的に利用するmakeルールとして以下を用意し、それ以外にも必要に応じて追加する。

| ルール名      | 役割                                                         |
| ------------- | ------------------------------------------------------------ |
| build-server  | 関連パッケージをinstallし、バックエンドサーバをビルドして、volumes/bin/にコピーする |
| build-chart   | chart_appのwebアプリをビルドして、dist/の下の生成物を、volumes/bin/chart_app/にコピーする。ビルド時に、node_modulesが存在しなければnpm installも実施する。 |
| build-setting | setting_appのwebアプリをビルドして、dist/の下の生成物を、volumes/bin/setting_app/にコピーする。ビルド時に、node_modulesが存在しなければnpm installも実施する。 |
| build         | build-server、build-chart、build-settingを全て実行する       |
| clean         | buildによる生成物、およびvolumes/bin/の下を全て削除する      |
| start         | docker composeを起動して、サービスを立ち上げる               |
| stop          | docker composeを終了する                                     |





