# チャートアプリ

チャートアプリは、診断チャートを登録するためのアプリである。チャートアプリのSPAは、React/TypeScript+viteでchart_app/に実装する。

また、チャートアプリは、通信できない状況でも動作するようにPWA（Progressive Web Application）として実装する。



## 画面と画面遷移

| 画面名           | 役割                                                         | 遷移先                         |
| ---------------- | ------------------------------------------------------------ | ------------------------------ |
| チャート選択画面 | 保存済みのチャートを選び（保存されている数だけボタンが出る）、写真登録画面に移動する | 写真登録画面                   |
| 写真登録画面     | 名刺の写真を撮る。撮影が完了して確認すると、チャート画面に移動する | チャート画面、チャート選択画面 |
| チャート画面     | Yes/Noチャートを表示する。設問文と選択肢ボタンを表示し、選択したボタンに応じて次の設問に切り替える。画面右上の終了ボタンを押すと、チャート選択画面に強制的に戻る。 | 結果表示画面、チャート選択画面 |
| 結果表示画面     | チャートの最終設問に回答すると、診断結果を表示する           | チャート選択画面               |

チャート選択画面、写真登録画面、結果表示画面でブラウザリロードされた場合は、チャート選択画面に戻る。

チャート画面では、途中経過をすべてlocal storageに保存しておき、ブラウザリロードした場合はチャート画面の途中状態にすぐに復帰する。



## チャート選択画面

チャート一覧画面では、バックエンドサーバに`/api/charts`のGETメッセージを送り、チャート一覧を取得する。受信する情報は、IChart型データのJSON文字列の配列である（つまり、string[]型で、各要素がJSON文字列になっている）。なお、チャート一覧が空の場合は、チャート未登録である旨を表示する。また、サーバから取得した情報は、次回以降通信途絶した時に備えて、local storageに保存しておく。

チャート一覧画面に遷移した直後に、local storageを削除すること。

受信データをIChart型オブジェクトに変換し、IResultオブジェクトを作成して、nameとtypeをIChartオブジェクトからコピーし、timestampに現在時刻（JST）をセットする。その後、選択されたチャートのオブジェクトを次の画面以降に渡す。

### 通信不能時および復旧時の対処

チャート一覧画面を表示して、`/api/charts`が成功したということは、サーバとの通信ができる状況である。もしこの時に、indexed DBに未送信の診断結果情報が残っていた場合は、バックエンドサーバの`/api/save`に一つずつ送信する。送信が成功したらindexed DBからそのレコードは削除する。もし送信に失敗した場合は、リトライはせず、次回のチャート一覧画面に遷移した時の試行に任せる。

`/api/charts`が失敗した場合で、チャート情報がlocal storageに保存されている場合は、そのチャート情報を利用して、以後の処理を実施する。これは通信が途絶してもアプリを利用できるようにするための次善策である。当然、チャート情報はサーバで更新されている可能性があるため、local storageの情報を利用した場合は、最新チャートと不整合が生じる可能性があるが、それは受け入れる。



## 写真登録画面

写真登録画面では、カメラを起動して撮影ボタンを表示する。撮影ボタンを押すと撮影して画像を取得する。画像はJPEG形式とし、それをBase64形式でIResultオブジェクトに格納する。撮影ボタンのほかに、画面右上に戻るボタン（またはバツボタン）も表示し、戻るボタンでチャート選択画面に戻る。

撮影後、「取り直し」ボタンと「進む」ボタンを表示する。取り直しの場合は、もう一度撮影からやり直す。進むボタンを押すと、IResultオブジェクトをlocal storageに保存してから、チャート画面に移動する。

なお、この画面でブラウザリロードした場合は、チャート選択画面に戻す。



## チャート画面

チャート画面では、IChartオブジェクトをのIQuestionの内容を画面に表示する。IQuestionのsentenceを大きく画面中央に表示し、choisesの内容を画面の下の方に、これも大きめのボタンで表示する。

チャートタイプがdecisionの場合、ボタンを押すと、choisesの要素に設定された要素番号のIQuestionを読み込んで、同じようにまたsentenceとchoiseを表示する。これを、isLast = falseの間は繰り返す。

チャートタイプがpointの場合、ボタンを押すと、choisesの要素に設定されたポイントをIResultオブジェクトのcurrentPointに加算して、次のIQuestionを読み込んで、同じようにまたsentenceとchoiseを表示する。これを、isLast = falseの間は繰り返す。

いずれのチャートタイプでも、IQuestion間の遷移時は、古い設問が上にスクロールしていき、次の設問が下からスクロールアップするようなアニメーションを入れる。

isLast=trueのIQuestionになると、同じようにまたsentenceとchoiseを表示するが、choiseのボタンを押した後に、diagnosesの中の診断結果IDのIDiagnosisオブジェクトを読み込んで、結果表示画面に遷移する。この遷移の時には、遷移前の画面全体にブラーをかけて、その後に結果表示画面をフェードインさせる。



## 結果表示画面

結果表示画面では、IDiagnosisオブジェクトのsentenceを大きく表示する。また、画面下部に「終了」ボタンを表示する。

終了ボタンを押すと、バックエンドサーバの`/api/save`にIResultオブジェクトを送信する。ただし、通信不能で送信に失敗した場合は、indexed DBに送信するはずだったデータを保存しておく。

結果表示画面でリロードした場合も、同じ画面表示に戻す。







